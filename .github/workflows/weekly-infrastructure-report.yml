name: Weekly Azure Infrastructure Report
on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 6 AM UTC

permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  generate-infrastructure-diagrams:
    runs-on: ubuntu-latest
    name: Generate Weekly Infrastructure Report
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Generate Complete Infrastructure Diagrams
        id: generate-diagrams
        uses: rfernandezdo/inventariographdrawio@v1
        with:
          diagram-mode: 'all'
          output-path: 'docs/azure-infrastructure-complete.drawio'
          export-json: 'docs/azure-inventory.json'
          commit-changes: 'pr'
          pr-title: 'Weekly Azure Infrastructure Update - ${{ github.run_number }}'
          pr-body: |
            ## ğŸ“Š Weekly Azure Infrastructure Update
            
            This automated PR contains the weekly update of our Azure infrastructure diagrams.
            
            ### ğŸ“ˆ Summary
            - **Total Resources**: ${{ steps.generate-diagrams.outputs.total-resources }}
            - **Total Dependencies**: ${{ steps.generate-diagrams.outputs.total-dependencies }}
            - **Tenant ID**: ${{ steps.generate-diagrams.outputs.tenant-id }}
            - **Generated**: ${{ github.run_number }}
            
            ### ğŸ“ Files Updated
            - `docs/azure-infrastructure-complete.drawio` - Multi-page diagram with all views
            - `docs/azure-inventory.json` - Raw inventory data for analysis
            
            ### ğŸ“– How to Use
            1. **View Diagrams**: Open the `.drawio` file in [draw.io](https://app.diagrams.net/)
            2. **Navigate Pages**: Use tabs at bottom for different views (Infrastructure, Components, Network)
            3. **Explore Data**: Click any resource and press Ctrl+M to see full details
            
            ---
            *ğŸ¤– This PR was automatically generated by the Azure Infrastructure Diagrams action*
      
      - name: Create Summary Comment
        if: steps.generate-diagrams.outputs.pr-number
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = '${{ steps.generate-diagrams.outputs.pr-number }}';
            const totalResources = '${{ steps.generate-diagrams.outputs.total-resources }}';
            const totalDependencies = '${{ steps.generate-diagrams.outputs.total-dependencies }}';
            
            const comment = `## ğŸ¯ Infrastructure Analysis Complete
            
            ### Key Metrics
            | Metric | Value |
            |--------|--------|
            | ğŸ“Š Total Resources | ${totalResources} |
            | ğŸ”— Dependencies | ${totalDependencies} |
            | ğŸ—ï¸ Diagram Pages | 4 (Infrastructure, Components, Network, Network Clean) |
            
            ### Quick Links
            - ğŸ“ˆ [Open Diagram in Draw.io](https://app.diagrams.net/?mode=github&org=${{ github.repository_owner }}&repo=${{ github.event.repository.name }}&ref=${{ github.head_ref }}&path=docs/azure-infrastructure-complete.drawio)
            - ğŸ’¾ [View Raw Data](https://github.com/${{ github.repository }}/blob/${{ github.head_ref }}/docs/azure-inventory.json)
            
            ### Actions Available
            - âœ… **Approve & Merge**: Update documentation with latest infrastructure
            - ğŸ” **Review Changes**: Compare with previous version to see what changed
            - ğŸ“¥ **Download**: Get diagrams locally for presentations
            `;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  notify-teams:
    needs: generate-infrastructure-diagrams
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Notify Microsoft Teams
        if: needs.generate-infrastructure-diagrams.result == 'success'
        uses: actions/github-script@v6
        with:
          script: |
            const webhook = '${{ secrets.TEAMS_WEBHOOK_URL }}';
            if (!webhook) {
              console.log('No Teams webhook configured, skipping notification');
              return;
            }
            
            const prNumber = '${{ needs.generate-infrastructure-diagrams.outputs.pr-number }}';
            const totalResources = '${{ needs.generate-infrastructure-diagrams.outputs.total-resources }}';
            
            const payload = {
              "@type": "MessageCard",
              "@context": "http://schema.org/extensions",
              "themeColor": "0078D4",
              "summary": "Azure Infrastructure Report Generated",
              "sections": [{
                "activityTitle": "ğŸ“Š Weekly Azure Infrastructure Report",
                "activitySubtitle": "Automated infrastructure diagram update completed",
                "facts": [
                  { "name": "Total Resources", "value": totalResources },
                  { "name": "Repository", "value": "${{ github.repository }}" },
                  { "name": "Run Number", "value": "${{ github.run_number }}" }
                ],
                "markdown": true
              }],
              "potentialAction": [{
                "@type": "OpenUri",
                "name": "View Pull Request",
                "targets": [{
                  "os": "default",
                  "uri": `https://github.com/${{ github.repository }}/pull/${prNumber}`
                }]
              }]
            };
            
            await fetch(webhook, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
