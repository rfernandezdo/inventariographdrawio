# Modos de Diagrama - Azure Infrastructure Diagrams

Este documento describe los diferentes modos de diagrama disponibles en Azure Infrastructure Diagrams, tanto para uso como CLI local como GitHub Action, basados en las recomendaciones de [Microsoft Learn sobre diagramas de dise√±o de arquitectura](https://learn.microsoft.com/es-es/azure/well-architected/architect-role/design-diagrams).

## üéØ Modos Disponibles

### 1. Infrastructure Mode (Por Defecto - **RECOMENDADO**)

#### Como GitHub Action
```yaml
- uses: rfernandezdo/inventariographdrawio@v2
  with:
    azure-credentials: ${{ secrets.AZURE_CREDENTIALS }}
    diagram-mode: 'infrastructure'  # o simplemente omitir (es el defecto)
```

#### Como CLI Local
```bash
python src/cli.py --diagram-mode infrastructure
python src/cli.py  # (modo por defecto)
```

**Prop√≥sito**: Diagrama de implementaci√≥n que muestra la jerarqu√≠a completa de Azure como un √°rbol jer√°rquico.

**üå≥ Algoritmo de √Årbol DFS Avanzado**:
- **B√∫squeda en profundidad**: Crea una estructura de √°rbol real (no solo niveles)
- **Filtrado inteligente**: Solo usa relaciones estructurales de Azure para el √°rbol principal
- **Escalabilidad probada**: Maneja >1000 recursos en <2 segundos (1,018 items/segundo)
- **25+ tipos de recursos**: Soporta todos los recursos comunes de Azure

**üìä Visualizaci√≥n Diferenciada**:
- üîµ **L√≠neas s√≥lidas azules**: Dependencias jer√°rquicas (Management Group ‚Üí Subscription ‚Üí Resource Group ‚Üí Resource)
- ‚ö™ **L√≠neas punteadas grises**: Relaciones de dependencia (networking, storage, etc.)
- ÔøΩ **Nodo ra√≠z inteligente**: Crea nodo virtual "Azure Tenant" si no hay Management Groups
- üìê **Layout perfecto**: Centrado autom√°tico y disposici√≥n balanceada

**Ejemplo de jerarqu√≠a real**:
```
üè¢ Azure Tenant (Root) ‚Üê Nodo ra√≠z virtual
‚îú‚îÄ‚îÄ ÔøΩ contoso-connectivity ‚Üê Management Group ra√≠z  
‚îÇ   ‚îú‚îÄ‚îÄ üìä contoso-platform ‚Üê MG hijo
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìä contoso-root ‚Üê MG nieto
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ üìã contoso-prod-001 ‚Üê Suscripci√≥n
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ üìÅ rg-network-prd-we-001 ‚Üê Resource Group
‚îÇ   ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ üåê vnet-hub-prd-we-001 ‚Üê VNet
‚îÇ   ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ üîó snet-gateway-prd-we-001 ‚Üê Subnet
‚îÇ   ‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ üåê pip-gateway-prd-we-001 ‚Üê Public IP
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ üìÅ rg-compute-prd-we-001 ‚Üê Resource Group
‚îÇ   ‚îÇ               ‚îî‚îÄ‚îÄ üõ°Ô∏è nsg-compute-prd-we-001 ‚Üê NSG  
3. **Conexi√≥n**: Conecta elementos hu√©rfanos por estructura de IDs de Azure
```
**Uso recomendado**: 
- ü§ñ **GitHub Action**: Informes autom√°ticos de infraestructura completa
- üë®‚Äçüíª **CLI Local**: Auditor√≠as y documentaci√≥n de arquitectura

---

### 2. Components Mode

#### Como GitHub Action
```yaml
- uses: rfernandezdo/inventariographdrawio@v2
  with:
    azure-credentials: ${{ secrets.AZURE_CREDENTIALS }}
    diagram-mode: 'components'
```

#### Como CLI Local

</details>

### 2. Components Mode
```bash
python src/cli.py --diagram-mode components
```

**Prop√≥sito**: Diagrama de componentes que agrupa recursos por funci√≥n/tipo.

**Caracter√≠sticas**:
- Agrupa recursos por categor√≠as funcionales:
  - **Governance**: Management Groups, Suscripciones, Resource Groups
  - **Compute**: VMs, App Services, AKS, Container Instances
  - **Storage**: Storage Accounts, Disks, File Shares
  - **Network**: VNets, Load Balancers, Firewalls, Public IPs
  - **Database**: SQL Server, CosmosDB, Database for MySQL/PostgreSQL
  - **Security**: Key Vaults, Managed Identity, Security Center
  - **AI/ML**: Cognitive Services, Machine Learning Workspaces
  - **Management**: Log Analytics, Application Insights, Automation
  - **Other**: Recursos que no encajan en las categor√≠as anteriores

- Disposici√≥n horizontal por grupos
- √ötil para entender la arquitectura por capas funcionales
- Ideal para presentaciones y an√°lisis de costos por categor√≠a

**Equivale a**: Diagrama de componentes seg√∫n Microsoft Learn

### 3. Network Mode
```bash
python src/cli.py --diagram-mode network
```

**Prop√≥sito**: Diagrama de red centrado en conectividad y recursos de networking, con estructura visual similar a los diagramas oficiales de Azure.

**Caracter√≠sticas**:
- Muestra recursos relacionados con la red y governance de forma estructurada
- **Agrupadores visuales**: VNets se muestran como contenedores grandes con subnets organizadas dentro
- **Recursos dentro de subnets**: VMs, App Services y otros recursos se posicionan autom√°ticamente dentro de sus subnets correspondientes (como en la imagen de referencia)
- Organizado por capas de red:
  - **Governance**: Management Groups, Suscripciones, Resource Groups (arriba)
  - **Internet**: Public IPs, Traffic Manager, DNS Zones
  - **Edge**: Application Gateway, Azure Firewall
  - **Load Balancing**: Load Balancers
  - **Virtual Networks**: VNets como contenedores con subnets dentro, y recursos posicionados dentro de cada subnet
  - **Connectivity**: VPN Gateways, ExpressRoute, Connections
  - **Network Security**: NSGs, Route Tables
  - **Other**: Recursos que no se pueden asociar a una subnet espec√≠fica

- **Disposici√≥n estructurada**: Cada VNet se muestra como un contenedor rectangular con l√≠neas punteadas, y las subnets se posicionan dentro como elementos organizados
- **Zonas claramente definidas**: Similar a los diagramas oficiales de Microsoft con contenedores para availability zones y subnets
- √ötil para an√°lisis de seguridad de red, troubleshooting y dise√±o de conectividad
- Ideal para equipos de networking y security

**Equivale a**: Diagrama de red seg√∫n Microsoft Learn, con inspiraci√≥n visual de los diagramas oficiales de Azure

## Ejemplos de Uso

### Caso 1: Auditor√≠a Completa de Infraestructura
```bash
python src/cli.py --diagram-mode infrastructure
```
Genera un diagrama completo mostrando toda la jerarqu√≠a de Azure.

### Caso 2: An√°lisis de Arquitectura por Componentes
```bash
python src/cli.py --diagram-mode components --include-ids /subscriptions/xxx-xxx-xxx
```
Muestra los recursos de una suscripci√≥n espec√≠fica agrupados por funci√≥n.

### Caso 3: Revisi√≥n de Seguridad de Red
```bash
python src/cli.py --diagram-mode network
```
Enfocado en recursos de red para an√°lisis de conectividad y seguridad.

### Caso 4: Documentaci√≥n de Entorno de Desarrollo
```bash
python src/cli.py --diagram-mode components --include-ids /subscriptions/dev-subscription-id --no-embed-data
```
Diagrama simplificado de componentes para un entorno espec√≠fico.

```bash
python src/cli.py --diagram-mode components
```

**Prop√≥sito**: Agrupa recursos por funci√≥n y tipo de servicio para an√°lisis arquitect√≥nico.

**Caracter√≠sticas**:
- üì¶ **Agrupaci√≥n funcional**: Compute, Storage, Network, Database, Security, AI/ML, etc.
- üéØ **Vista de servicios**: Ideal para an√°lisis de costos y tecnolog√≠as utilizadas
- üìä **Resumen de arquitectura**: Visi√≥n general de componentes sin jerarqu√≠a organizacional

**Uso recomendado**:
- ü§ñ **GitHub Action**: An√°lisis de componentes utilizados por entorno
- üë®‚Äçüíª **CLI Local**: Presentaciones ejecutivas y an√°lisis de servicios

---

### 3. Network Mode

#### Como GitHub Action
```yaml
- uses: rfernandezdo/inventariographdrawio@v2
  with:
    azure-credentials: ${{ secrets.AZURE_CREDENTIALS }}
    diagram-mode: 'network'
    no-hierarchy-edges: true  # Opcional: solo dependencias funcionales
```

#### Como CLI Local
```bash
python src/cli.py --diagram-mode network
python src/cli.py --diagram-mode network --no-hierarchy-edges  # Solo deps funcionales
```

**Prop√≥sito**: Vista centrada en recursos de red y topolog√≠a de conectividad.

**üåê Caracter√≠sticas Avanzadas**:
- **Contenci√≥n jer√°rquica**: RG ‚Üí VNet ‚Üí Subnet ‚Üí Recursos
- **Multi-Subnet Support**: NSGs y Route Tables aparecen tanto en RG original como asignados a subnets
- **Filtrado inteligente**: Opci√≥n `--no-hierarchy-edges` para mostrar solo ~21 dependencias funcionales vs ~100 jer√°rquicas
- **Clasificaci√≥n autom√°tica**: Recursos categorizados por funci√≥n (edge, connectivity, security)

**Elementos especiales**:
- üîµ **NSGs multi-subnet**: Elemento original en RG + copias "(asignaci√≥n)" en cada subnet
- üîß **Route Tables multi-subnet**: Elemento original en RG + copias "(asignaci√≥n)" en cada subnet  
- üëª **Recursos "hidden"**: Cubo azul sombreado para elementos auxiliares

**Uso recomendado**:
- ü§ñ **GitHub Action**: Diagramas de topolog√≠a de red para an√°lisis de conectividad
- üë®‚Äçüíª **CLI Local**: An√°lisis de arquitectura de red y troubleshooting

---

### 4. All Mode (Multi-p√°gina - **RECOMENDADO para GitHub Action**)

#### Como GitHub Action
```yaml
- uses: rfernandezdo/inventariographdrawio@v2
  with:
    azure-credentials: ${{ secrets.AZURE_CREDENTIALS }}
    diagram-mode: 'all'  # Un solo archivo, m√∫ltiples p√°ginas
```

#### Como CLI Local
```bash
python src/cli.py --diagram-mode all
```

**Prop√≥sito**: Todas las vistas en un solo archivo draw.io con p√°ginas separadas.

**üìÑ 4 P√°ginas en un solo archivo**:
1. **Infrastructure**: Jerarqu√≠a completa con conexiones padre-hijo
2. **Components**: Agrupaci√≥n por tipo de servicio y funci√≥n  
3. **Network**: Vista de red con enlaces jer√°rquicos completos
4. **Network (Clean)**: Vista de red solo con dependencias funcionales (~21 enlaces vs ~100)

**Ventajas del modo All**:
- üéØ **Un solo archivo**: Todas las vistas en un archivo consolidado
- üîÑ **Navegaci√≥n f√°cil**: Pesta√±as en draw.io para cambiar entre vistas
- üìä **Vista integral**: An√°lisis completo desde diferentes perspectivas
- ü§ñ **Ideal para GitHub Action**: Genera documentaci√≥n completa autom√°ticamente

**Uso recomendado**:
- ‚úÖ **GitHub Action**: Modo por defecto para informes autom√°ticos completos
- ‚úÖ **CLI Local**: Documentaci√≥n completa para presentaciones y auditor√≠as

## üöÄ Casos de Uso por Modo

### Infrastructure Mode
- ‚úÖ **Auditor√≠as de compliance**: Vista jer√°rquica completa para governance
- ‚úÖ **Documentaci√≥n oficial**: Estructura organizacional clara
- ‚úÖ **Onboarding**: Mostrar estructura completa a nuevos miembros del equipo

### Components Mode  
- ‚úÖ **An√°lisis de costos**: Agrupar por tipo de servicio para cost management
- ‚úÖ **Presentaciones ejecutivas**: Vista de alto nivel sin detalles t√©cnicos
- ‚úÖ **Technology stack review**: Evaluar tecnolog√≠as utilizadas

### Network Mode
- ‚úÖ **Troubleshooting de conectividad**: An√°lisis de topolog√≠a de red
- ‚úÖ **Planificaci√≥n de seguridad**: Revisar NSGs, firewalls y zonas
- ‚úÖ **An√°lisis de tr√°fico**: Entender flujos de red entre componentes

### All Mode
- ‚úÖ **Informes autom√°ticos**: GitHub Action genera documentaci√≥n completa
- ‚úÖ **Auditor√≠as integrales**: Todas las perspectivas en un solo lugar
- ‚úÖ **Documentaci√≥n viva**: Actualizaciones autom√°ticas con PRs

### üéØ Caracter√≠sticas Visuales y Layout

#### Layout Jer√°rquico (Infrastructure Mode)
- ‚úÖ **DFS Tree Algorithm**: Estructura de √°rbol real usando b√∫squeda en profundidad
- ‚úÖ **Centrado autom√°tico**: Padres centrados respecto a sus hijos
- ‚úÖ **Sin solapamientos**: Espaciado inteligente adaptativo
- ‚úÖ **Nodo ra√≠z virtual**: "Azure Tenant" cuando no hay Management Groups

#### Layout de Red (Network Mode)  
- ‚úÖ **Contenci√≥n jer√°rquica**: RG ‚Üí VNet ‚Üí Subnet ‚Üí Recursos
- ‚úÖ **Multi-subnet support**: NSGs/Route Tables originales + asignaciones
- ‚úÖ **Dimensiones din√°micas**: Contenedores adaptativos al contenido
- ‚úÖ **Layout en arco**: Resource Groups con ‚â•4 recursos usan semic√≠rculo

#### Iconos y Estilos
- ‚úÖ **Iconos oficiales Azure**: Biblioteca completa img/lib/azure2/
- ‚úÖ **Estilos diferenciados**: Containers, recursos normales, recursos "hidden"
- ‚úÖ **L√≠neas tipificadas**: S√≥lidas (jer√°rquica) vs punteadas (dependencia)

### üîß Opciones de Personalizaci√≥n

#### Filtrado por Recursos
```bash
# CLI
--include-ids '/subscriptions/prod-sub /resourceGroups/prod-rg'
--exclude-ids '/subscriptions/dev-sub'

# GitHub Action
include-ids: '/subscriptions/prod-sub /resourceGroups/prod-rg'
exclude-ids: '/subscriptions/dev-sub'
```

#### Filtrado por Tenant
```bash  
# CLI
--tenant-filter 'aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee'
--all-tenants

# GitHub Action  
tenant-filter: 'aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee'
all-tenants: true
```

#### Opciones de Datos
```bash
# CLI
--no-embed-data     # Archivos m√°s ligeros
--export-json       # Exportar datos para an√°lisis

# GitHub Action
no-embed-data: true
export-json: 'azure-inventory.json'
```

### üìã Siguientes Pasos

#### Visualizaci√≥n en Draw.io
1. üåê **Abrir**: Usa [draw.io](https://app.diagrams.net/) 
2. üìê **Organizar**: Selecciona todo (Ctrl+A) ‚Üí Men√∫ 'Organizar' ‚Üí 'Disposici√≥n' ‚Üí 'Gr√°fico Jer√°rquico'
3. üîç **Explorar**: Click en cualquier recurso + Ctrl+M para ver metadatos
4. üìÑ **Navegar**: Usa pesta√±as inferiores para cambiar entre p√°ginas (modo All)

#### Automatizaci√≥n con GitHub Action
1. üîß **Setup**: Sigue [SETUP_GITHUB_ACTION.md](../SETUP_GITHUB_ACTION.md)
2. üìÖ **Schedule**: Configura runs autom√°ticos semanales/diarios
3. üìä **Monitor**: Revisa PRs autom√°ticos con diagramas actualizados
4. üîÑ **Iterate**: Ajusta filtros y configuraci√≥n seg√∫n necesidades

### üèÜ Recomendaciones por Caso de Uso

| Caso de Uso | Modo Recomendado | GitHub Action | CLI Local |
|-------------|------------------|---------------|-----------|
| **Informes autom√°ticos** | `all` | ‚úÖ Ideal | ‚ùå Manual |
| **Auditor√≠as compliance** | `infrastructure` | ‚úÖ Programado | ‚úÖ Ad-hoc |
| **An√°lisis de red** | `network` | ‚úÖ Cambios | ‚úÖ Troubleshooting |
| **Presentaciones ejecutivas** | `components` | ‚ùå Overkill | ‚úÖ Perfecto |
| **Documentaci√≥n viva** | `all` | ‚úÖ PRs autom√°ticos | ‚ùå Manual |
| **An√°lisis de costos** | `components` | ‚úÖ Reportes | ‚úÖ An√°lisis |

---

üí° **Tip**: Para m√°ximo valor, usa el modo `all` con GitHub Action para generar documentaci√≥n autom√°tica completa, y luego usa modos espec√≠ficos localmente para an√°lisis detallados.
- **‚â•4 recursos**: Usa disposici√≥n radial (c√≠rculo)
- **<4 recursos**: Mantiene layout lineal horizontal  
- **Centro inteligente**: Resource Group en el centro del c√≠rculo
- **Radio adaptativo**: Se ajusta autom√°ticamente al n√∫mero de recursos
- **Distribuci√≥n uniforme**: √Ångulos equidistantes entre recursos
- **Conexiones optimizadas**: L√≠neas radiales desde el centro

**Ventajas visuales:**
- üéØ **M√°s compacto**: Reduce significativamente el ancho del diagrama
- üé® **Est√©ticamente superior**: C√≠rculos balanceados y armoniosos  
- üîç **F√°cil identificaci√≥n**: RG claramente visible en el centro
- ‚ö° **Conexiones cortas**: L√≠neas radiales m√°s directas
- üìê **Escalable**: Maneja desde 4 hasta 20+ recursos elegantemente

**Ejemplo visual:**
```
        [VM-1]     [Storage]
           \         /
    [KeyVault] -- [RG] -- [VNet]
           /         \
      [SQL-DB]     [LoadBalancer]
```

**Rendimiento verificado**: 1,290 recursos/segundo con layout radial
